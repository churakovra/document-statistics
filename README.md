# document-statistics
 
Позволяет загрузить файл и увидеть статистику 
* tf - отношение числа вхождений слова к общему числу слов документа.
* idf - инверсия частоты, с которой некоторое слово встречается в документах коллекции.
___
## Структура
```
document-statistics/  
|--app/                     # Бекенд сервис 
|  |--api/                  # Роутеры и эндпоинты
|  |--config/               # Конфигурационные файлы
|  |--db/
|     |--models/            # ORM модели
|     |database.py          # Файл инициализации БД
|  |--dependencies/         # DI методы для валидации ресурсов
|  |--enums/                # Наборы енамов
|  |--exceptions/           # Кастомные ошибки
|  |--repositories/         # Репозитории (Реализация работы с БД)
|  |--schemas/              # Pydantic схемы
|  |--services/             # Сервисы (Реализация логики)
|  |--utils/                # Технические классы и методы
|  |--main.py               # Точка входа
|
|--app-frontend/            # Простой UI Streamlit
|  |frontend.py
|
|--storage/                 # Volume для хранения загружаемых файлов
|
|--tests/                   # Тесты
|  |--integration/
|  |--unit/
|  |conftest.py
|
|.env                       # Переменные окружения
|docker-compose.yml         # Собирает и запускает приложение
|Dockerfile                 # Образ backend и frontend сервисов
|README.md                  # Документация проекта
|requirements-*.txt         # Зависимости
```
___
## Запуск

1. Создать папку приложения и перейти в неё
```bash
mkdir app && cd app
```
2. Склонировать репозиторий
```bash
git clone https://github.com/churakovra/document-statistics.git .
```
3. Открыть и заполнить .env-example файл затем переименовать его в .env
```bash
mv .env_example .env
```
4. Создать volume ds-pg
```bash
docker volume create ds-pg
```
5. Запустить сборку проекта
```bash
docker-compose up --build
```
  - Сервис доступен по ссылке [http://localhost:8000](http://localhost:8000)
  - Документация Swagger доступна по ссылке [http://localhost:8000/docs](http://localhost:8000/docs)
  - Если запускать на VM, то вместо `localhost` подставлять `ip` VM
6. Если докер компоуз не хочет заводиться, можно почистить кеш volume
```bash
docker-compose down -v
docker-compose up --build
```
___
### Фидбек от телеграм юзера `@amal_sultanov`
#### Что понравилось
- Структурирование проекта
- Реализация регистрации/входа в аккаунт
- Обработка ошибок
#### Трудности при запуске
- Отсутствуют 
#### Предложенные изменения
- Описать исключение загрузки пустого файла в Swagger
- Запретить загружать документ не соответствующий .txt формату (получилось загрузить pdf и png, однако при обращении к эндпоинту на получение содержимого документа получил UnicodeDecodeError)
- Проверить описание POST /collections в swagger
- Убрать пробелы перед командами для запуска проекта в README (не критично)
___
## Changelog
_Version 1.3.0_
- Добавлен endpoint для получения закодированного содержимого файла
  - GET /documents/{document_id}/huffman
___
_Version 1.2.1_
- Внесены исправления согласно предложенным изменениям
  - Добавлены HTTPException в места, где может всплыть ошибка с пустым документом; Добавлено описание Swagger
  - Добавлена проверка на тип загружаемого документа
  - Исправлено описание в Swagger для endpoint'ов
    - POST /add_collection_document
    - GET /collections
    - POST /collections
    - DELETE /collections/{collection_id}/{document_id}
    - GET /collections/{collection_id}/statistics
    - GET /documents/{document_id}/statistics
  - Удалены пробелы в командах для запуска проекта
___
_Version 1.2.0_

- Полностью переписан сервис в процессе реализации новых требований
  - Добавлены сущности
    - Документ
    - Коллекция
    - Пользователь
    - Статистика
  - Внедрены слои для выполнения логики Handler -> Service -> Repository
  - Добавлены аннотации в хендлеры для расширения документации Swagger
  - Реализована новая структура БД [Диаграмма](ds_db-public.png)
  - Добавлен требуемый функционал
    - Авторизация пользователя, управление аккаунтом
    - Управление документами (требуется авторизация, проверяется через куки)
    - Управление коллекциями
      - Для каждого пользователя при первичной загрузке документа создается Базовая коллекция -- коллекция с названием username_base и флагом base. Она обязательна для каждого пользователя, документы при загрузке автоматически попадают в нее, статистика для документа (/documens/\<document_id\/statistics>) тоже считается для документа в контексте базовой коллекции
  - Дополнительно реализовано:
    - Возможность добавления документа во множество коллекций
    - Возможность создавать коллекции с собственным названием
    - id для всех сущностей в приложении имеют тип UUID, задается через UUID 4 версии
    - Запрашиваемая статистика записывается в БД и при повторном вызове возвращается, предотвращая ненужный пересчет
  
  
  Для работы с API нужны cookie, которые присваиваются пользователю после POST /login  
  Достать их можно через консоль chrome командой `document.cookie`
___
_Version 1.1.0_

- Проведён рефактор проекта
  - API хендлеры вынесены в соответствующий пакет
  - Вынесен в отдельный слой Repo функционал для работы с БД
  - Вынесен в отдельный слой Service функционал, выполняющий бизнес-логику
  - Фронт вынесен в отдельный пакет на уровень с беком
  - Переименованы функции, файлы - даны более лаконичные названия
  - Переименованы инстансы в БД
- Добавлены новые ручки
  - /status - Возвращает `{"status":"OK"}`, если приложение работоспособно
  - /version - Возвращает `{"version":"<curr_version>"}`
  - /metrics - Возвращает json с метриками приложения и их описанием `{"metric":"description"}`
    - Добавлены 2 метрики:
      - "unique_user_count": "(int) кол-во уникальных пользователей, загрузивших хотя бы 1 файл"
      - "avg_files_per_user": "(float) среднее кол-во файлов с точностью 3 знака после запятой, загруженных пользователем"
- Уменьшен размер Docker образов:
  - Для backend image размер изменился 1.5 ГБ -> 286 МБ
  - Для frontend image размер изменился 1.5 ГБ -> 753 МБ
- Оптимизирован docker-compose
- Добавлена структура проекта в Readme
- Добавлен Changelog
___
_Version 1.0.0_
- Версия проекта на момент сдачи, реализованный функционал:
  - Загрузка файла через WEB интерфейс, последующее отображение таблицы со статистикой по словам
  - Подключена БД (PG) для хранения загруженных файлов, слов и создания возможности получения статистики  
  - Переменные окружения вынесены в .env файл
  - Для запуска сервиса создан Dockerfile, образ которого билдится в docker-compose
  - Написаны первичные автотесты основного функционала
___